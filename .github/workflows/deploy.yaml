name: Trigger Helm Deploy

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Docker Image Tag to Deploy"
        required: true
      zone:
        description: "Deployment Zone"
        required: true
        default: "staging"
  
  repository_dispatch:  # Trigger ผ่าน API
    types: [deploy]

env:
  APP_NAME: node-be
  APP_ENV: "dev"
  CONTAINER_REPOSITORY: "ghcr.io"
  OWNER_NAME: "sompornic"
  IMAGE_TAG: "dev1.0.${{ github.run_number }}"
  GIT_BRANCH: "develop"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Helm Chart Repo
        uses: actions/checkout@v3
        with:
          repository: sompornic/helm-app
          ref: main
          token: ${{ secrets.PAT_TOKEN }}
          path: helm-chart

      - name: Set Kubernetes Context Based on Zone
        uses: azure/k8s-set-context@v1
        with:
          kubeconfig: |
            ${{ 
              github.event.client_payload.zone == 'dev' && secrets.KUBE_CONFIG_DEV ||
              github.event.inputs.zone == 'staging' && secrets.KUBE_CONFIG_STAGING ||
              ''
            }}

      - name: Deploy with Helm
        if: github.event.client_payload.zone == 'dev' || github.event.inputs.zone == 'staging'
        run: |
          cd helm-chart/$APP_NAME
          helm upgrade --install $APP_NAME ./ --namespace testdeploy --create-namespace